# 2-Stage Detectors

* * * 

## R-CNN

<img width="761" alt="image" src="https://user-images.githubusercontent.com/93971443/201673413-524c22eb-38ae-4f90-be42-eb2cf650cc55.png">

    - ※ sliding window :  다양한 스케일의 박스를 이미지 전체에 적용 -> 비효율적 잘 사용X
    - ※ selective search : 영역을 잘게 나눈 후 순차적으로 통합

#### Pipe line
1) 이미지를 입력 받음
2) selective search를 통해 약 2000개의 RoI 추출
    - RoI : Region of Interest
3) RoI의 크기를 CNN fc layer에 넣어야 하므로 모두 동일한 사이즈로 변경(-> warping)
    - CNN fc layer : 입력 사이즈가 고정되어 있음
4) sementic feature vector 추출
    - 각 region마다 4096-dim feature vector 추출
    - pretrained Alexnet 사용
5) (4)에서 나온 feature를 SVM을 이용하여 classify 진행
    - Input : 2000 * 4096 features
    - Output : Class(# of labels + 1(배경)) + confidence score   
      ※ confidence score : class일 확률 * IoU // bounding box 내에 해당 class가 존재할 확률
6) selective search로 부터 나온 bbox : 굉장히 rough함
7) GT에 맞도록 bbox의 중심좌표(x, y), W, H Linear regression 진행

##### <전체 process>
<img width="552" alt="image" src="https://user-images.githubusercontent.com/93971443/201682412-0da50653-6ccd-4b81-a7c8-bc4cf264b92d.png">


#### Training
- Alexnet 
  - Domain specific fine-tuning 진행
  - Dataset 구성
    - IoU > 0.5 : positive samples
    - IoU < 0.5 : negative samples
    - Positive samples - 32개 / Negative samples - 96개 
    - 총 128개의 batch 구성

- Linear SVM 
  - Dataset 구성
    - GT : positive samples
    - IoU < 0.3 : negative samples
    - Positive samples 32, negative samples 96
  - Hard negative mining
    - Hard negative : False Positive
    - 배경으로 식별하기 어려운 샘플들을 강제로 다음 배치의 negative sample로 mining 
- Bbox regressor
  - Dataset 구성
    - IoU > 0.6 : positive samples
  - Loss function
    - MSE loss

- 여기서 알 수 있는 것 : 각각의 과정마다 dataset을 다르게 구성한다.

* * *

## SPPNet

* R-CNN의 한계점을 극복하기 위해 만들어짐
  * CNN fc layer의 입력 이미지가 고정되어 있기 때문에 추가적인 warping이 필요
  * 약 2000개의 RoI가 각각 CNN을 통과해야함 -> 시간 소요 up

<img width="748" alt="image" src="https://user-images.githubusercontent.com/93971443/201682198-b17ff94c-aa9e-4734-9d5d-7cb587af2a37.png">

- R-CNN과의 차이점 : image input을 바로 CNN layer에 넣어 고정된 feature map을 얻은 후 SPP(spatial pyramid pooling)을 이용함

<img width="537" alt="image" src="https://user-images.githubusercontent.com/93971443/201683069-9f2d4fa2-65dc-4b39-9f36-f43535b9e486.png">


### SPP(spatial pyramid pooling)
<img width="581" alt="image" src="https://user-images.githubusercontent.com/93971443/201683691-832c618b-5ed0-4611-8ab2-4c045dec7c72.png">

- 다양한 RoI를 고정된 feature vector로 만들기 위해 사용
1) target bin size를 정함
2) 다음과 같이 target bin size에 맞게 pooling을 진행함 -> 각 셀마다 binning을 진행(input size에 따라 다르게 진행)

<img width="694" alt="image" src="https://user-images.githubusercontent.com/93971443/201684410-3aa83b99-5b71-4ce9-81bd-514f18b48756.png">

3) 고정된 size feature vector을 얻을 수 있음
